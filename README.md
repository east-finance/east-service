# EAST service

## Архитектура

### База данных
Сущности транзакций, балансов, vaults и прочее хранятся не в виде сущностей а в виде журнала где на каждое изменение вставляется новая запись. Для того чтобы узнать актуальный баланс,транзакцию или значение vault нужно взять последнюю запись. При роллбеке удаляются только блоки, все записи в журналах удаляются автоматически через DELETE CASCADE получая при этом новое состояние для сущностей, таким образом отпадает необходимость вручную обрабатывать роллбэки.


## Логика работы без технических деталей:

### Покупка и сопровождение EAST токенов
1. Для покупки EAST пользователь отправляет трансфер с WEST на единый адрес(EAST_SERVICE_PUBLIC_KEY). Адрес этот не меняется для прозрачности сделок.

2. При появлении трансфера в блокчейне сервис автоматизации берёт транзакции ораклов наиболее близкие по времени к времени трансфера. Для того чтобы использовать ораклы для расчёта колличества EAST разница между времени блока (block.timestamp) и oracle_data.timestamp не должна превышать константу EXPIRED_ORACLE_DATA.
    вопросы: 
    2.1. в случае неудовлетворения условий - возвращать деньги обратным трансфером?? в данный момент сервис просто падает и не встаёт. TODO
    2.2. гипотетически обработка блокчейна может затянуться, курс может измениться. есть вариант брать курс из последних ораклов??(нечестно по отошению к пользователю), в этом случае oracle_data.timestamp не должен отставать от текущего времени более чем на EXPIRED_ORACLE_DATA. Либо все исторические трансферы отправлять обратно пользователю.

3. Сервис автоматизации расчитывает количество EAST используя ораклы из пункта 2. вызывает east контракт c ключом mint, отправляет:
    - количество купленых истов
    - количество USDP и WEST для vault пользователя
    - id транзакций ораклов использовавшихся для расчёта и биржевые курсы из данных ораклов.
    - адрес пользователя из трансфера
С ключом mint может вызывать данный контракт только его создатель.

4. Контракт добавляет в свой стэйт пользователю токенов EAST. Так же конракт создаёт vault для пользователся с указанным количеством токенов (не реализовано в данный момент на стороне контракта).
    вопросы: 
    4.1 в качестве id для vault пользователя предлагаю взять id самой транзакции docker call?
    4.2 поскольку мы передаём id транзакций ораклов то гипотетически мы можем расчитывать количество EAST на стороне контракта а не в сервисе автоматизации.??

// далее ещё не реализовано

5. Пользователь для дообеспечения своего vault переводит токенов на единый адрес EAST_SERVICE_PUBLIC_KEY где в сообщении указывает ID своего vault, при получении трансфера сервис автоматизации в свою очередь отправляет docker call с суммой перевода, контракт пополняет vault.

6. Для ликвидации позиции(vault) пользователь отправляет docker call с запросом на ликвидацию, сервис автоматизации при получении запроса отправляет атомиком пользователю трансферы с USPD, WEST и docker call с ликвидацией позиции, контракт удаляет vault и снимает со счёта пользователя EAST.
    вопрос:
    6.1 на груминге говорили что то про то что не нужна ликвидация??